<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scraper de Precios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">Scraper de Precios</a>
    </div>
  </nav>

  <div class="container">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form method="post" action="/extract" class="row g-3" id="scrape-form">
          <div class="col-12">
            <label for="url" class="form-label">URL</label>
            <input type="url" class="form-control" id="url" name="url" placeholder="https://..." value="{{ defaults.url }}" required />
          </div>
          <div class="col-md-3">
            <div class="form-check form-switch mt-4">
              <input class="form-check-input" type="checkbox" role="switch" id="use_llm" name="use_llm" {% if defaults.use_llm %}checked{% endif %}>
              <label class="form-check-label" for="use_llm">Usar LLM</label>
            </div>
          </div>
          <div class="col-md-3">
            <label for="model" class="form-label">Modelo</label>
            <input type="text" class="form-control" id="model" name="model" value="{{ defaults.model }}" />
          </div>
          <div class="col-md-3">
            <label for="max_chars" class="form-label">MÃ¡x. caracteres</label>
            <input type="number" class="form-control" id="max_chars" name="max_chars" value="{{ defaults.max_chars }}" />
          </div>
          <div class="col-md-3">
            <label for="api_key" class="form-label">OPENAI_API_KEY (opcional)</label>
            <input type="password" class="form-control" id="api_key" name="api_key" placeholder="sk-..." />
          </div>
          <div class="col-md-6">
            <label for="email_to" class="form-label">Enviar reporte a</label>
            <input type="email" class="form-control" id="email_to" placeholder="correo@ejemplo.com" value="{{ defaults.email_to or 'agustin.ledezma@ucb.edu.bo' }}" />
          </div>
          <div class="col-md-6">
            <label for="email_subject" class="form-label">Asunto</label>
            <input type="text" class="form-control" id="email_subject" value="Reporte de precios" />
          </div>
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">Ejecutar</button>
            <button class="btn btn-outline-secondary" type="button" id="btnExport">Exportar JSON</button>
            <button class="btn btn-success" type="button" id="btnEmail">Enviar por email</button>
          </div>
        </form>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if result %}
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div>
              <span class="badge bg-primary me-2">URL</span> <code>{{ result.url }}</code>
            </div>
            <div>
              <span class="badge bg-info me-2">Original</span> {{ result.original_len or 0 }} chars
              {% if result.use_llm %}
                <span class="badge bg-warning text-dark ms-3 me-2">LLM</span> {{ result.model }}
                <span class="badge bg-success ms-3 me-2">Reducido</span> {{ result.reduced_len or 0 }} chars
              {% endif %}
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" id="filterText" class="form-control" placeholder="Filtrar por texto (contexto, moneda, valor)" />
            </div>
            <div class="col-md-3">
              <select id="sortBy" class="form-select">
                <option value="value">Ordenar por valor</option>
                <option value="currency">Ordenar por moneda</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="sortDir" class="form-select">
                <option value="asc">Ascendente</option>
                <option value="desc">Descendente</option>
              </select>
            </div>
          </div>

          <div id="results" class="row g-3">
            <!-- Cards will be rendered by JS -->
          </div>
        </div>
      </div>

      <script id="data-json" type="application/json">{{ result.result | tojson | safe }}</script>
      <script id="meta-json" type="application/json">{{ {
        'url': result.url,
        'model': result.model,
        'original_len': result.original_len,
        'reduced_len': result.reduced_len
      } | tojson | safe }}</script>
      <script>
        window.__DATA__ = JSON.parse(document.getElementById('data-json').textContent);
        window.__META__ = JSON.parse(document.getElementById('meta-json').textContent);
      </script>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/ui.js"></script>
</body>
</html>
